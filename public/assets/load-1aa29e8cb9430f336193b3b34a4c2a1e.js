/*jslint browser: true, continue: true, eqeq: true, plusplus: true, vars: true, white: true */
var FlattrLoader=function(){"use strict";var e={instance:!1,queryString:!1,validParams:["mode","https","uid","category","button","language","html5-key-prefix","popout","revsharekey"],validButtonParams:["uid","owner","category","button","language","hidden","tags","title","url","description","revsharekey","popout"],options:{},POPOUT_WIDTH:401,POPOUT_HEIGHT:230,TIMEOUT:1500,createIframe:function(t){var n=t.button=="compact",r=document.createElement("iframe");return r.setAttribute("src",(this.getParam("https")==1?"https":"http")+"://"+this.getParam("domain","api.flattr.com")+"/button/view/?"+this.encodeData(t)),r.setAttribute("class","FlattrButton"),r.setAttribute("width",n==1?110:55),r.setAttribute("height",n==1?20:62),r.setAttribute("frameBorder",0),r.setAttribute("scrolling","no"),r.setAttribute("border",0),r.setAttribute("marginHeight",0),r.setAttribute("marginWidth",0),r.setAttribute("allowTransparency","true"),r.data=t,t.popout!=0&&(r.onmouseover=function(){this.popoutIframe===undefined&&(e.removeAllOpenPopoutIframes(),e.showPopoutForButton(this),this.popoutIframe.onmouseover=function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=undefined)},this.popoutIframe.onmouseout=function(){this.parentNode&&(this.timeout=setTimeout(function(){r.popoutIframe&&e.removePopoutForButton(r)},e.TIMEOUT))})},r.onmouseout=function(){this.popoutIframe&&(this.popoutIframe.timeout=setTimeout(function(){r.popoutIframe&&e.removePopoutForButton(r)},e.TIMEOUT))}),r},getAbsolutePositionForElement:function(e){var t={x:0,y:0};if(e.offsetParent)do t.x+=e.offsetLeft,t.y+=e.offsetTop,e=e.offsetParent;while(e);return t},showPopoutForButton:function(e){var t,n="s",r="e",i=window.innerWidth!==undefined?window.innerWidth:document.documentElement.clientWidth,s=window.innerHeight!==undefined?window.innerHeight:document.documentElement.clientHeight,o=this.getAbsolutePositionForElement(e);o.x>i/2&&(r="w"),o.y+Number(e.height)+this.POPOUT_HEIGHT>s&&(n="n"),t=n+r,e.data.dir=t,e.popoutIframe=this.createPopoutIframe(e.data),r==="w"?e.popoutIframe.style.left=Number(o.x)-Number(this.POPOUT_WIDTH)+Number(e.width)+"px":r==="e"&&(e.popoutIframe.style.left=o.x+"px"),n==="n"?e.popoutIframe.style.top=Number(o.y)-Number(this.POPOUT_HEIGHT)+"px":n==="s"&&(e.popoutIframe.style.top=Number(o.y)+Number(e.height)+"px"),document.querySelector("body").appendChild(e.popoutIframe)},createPopoutIframe:function(e){var t=document.createElement("iframe");return t.setAttribute("src",(this.getParam("https")==1?"https":"http")+"://"+this.getParam("domain","api.flattr.com")+"/button/popout/?"+this.encodeData(e)),t.setAttribute("frameBorder",0),t.setAttribute("allowTransparency","true"),t.setAttribute("style","position: absolute; display:block; z-index: 9999;"),t.setAttribute("width",this.POPOUT_WIDTH),t.setAttribute("height",this.POPOUT_HEIGHT),t},removePopoutForButton:function(e){e.popoutIframe.timeout&&clearTimeout(e.popoutIframe.timeout),e.popoutIframe.parentNode.removeChild(e.popoutIframe),e.popoutIframe=undefined},removeAllOpenPopoutIframes:function(){var e=document.querySelectorAll("iframe.FlattrButton"),t,n;for(t=0;t<e.length;t+=1)n=e[t],n.popoutIframe&&this.removePopoutForButton(n)},reshowAllOpenPopoutIframes:function(){var e=document.querySelectorAll("iframe.FlattrButton"),t,n;for(t=0;t<e.length;t+=1)n=e[t],n.popoutIframe&&(this.removePopoutForButton(n),this.showPopoutForButton(n))},encodeData:function(e){var t,n,r="";for(t in e)e.hasOwnProperty(t)&&(n=e[t],t=="description"&&(n=this.stripTags(n,"<br>"),n.length>1e3&&(n=n.substring(0,1e3))),n=n.replace(/^\s+|\s+$/g,"").replace(/\s{2,}|\t+/g," "),r+=t+"="+encodeURIComponent(n)+"&");return r},getParam:function(e,t){return typeof this.options[e]!="undefined"?this.options[e]:t},init:function(){var t,n,r,i,s,o,u,f,l,c,h,p,d=document.getElementsByTagName("script");try{for(t=d.length-1;t>=0;t--){n=d[t];if(!n.hasAttribute("src"))continue;r=n.src,i=new RegExp("^(http(?:s?))://(api\\.(?:.*\\.?)flattr\\.(?:com|dev))","i"),s=r.match(i);if(s){this.options.domain=s[2].toString(),this.options.https=s[1].toString()=="https"?1:0,o=r.indexOf("?");if(o){u=r.substring(++o),f=u.split("&");for(c=0;c<f.length;c++)l=f[c].split("="),this.validParam(l[0],this.validParams)&&(this.options[l[0]]=l[1])}this.instance=n;break}}}catch(v){}window.addEventListener!==undefined?(h=window.addEventListener,p="message"):(h=window.attachEvent,p="onmessage"),h(p,function(t){var n;try{n=JSON.parse(t.data)}catch(r){n={}}n.flattr_button_event==="popout_close_button_clicked"?e.removeAllOpenPopoutIframes():n.flattr_button_event==="click_successful"&&e.reshowAllOpenPopoutIframes()},!1);switch(this.getParam("mode","manual")){case"direct":this.render();break;case"auto":case"automatic":var m=this;this.domReady(function(){m.setup()});break;case"manual":default:}return this},loadButton:function(e){var t,n,r,i,s,o={},u=null;for(t in this.options)this.options.hasOwnProperty(t)&&this.validParam(t,this.validButtonParams)&&(o[t]=this.options[t]);e.href&&(o.url=e.href),e.getAttribute("title")&&(o.title=e.getAttribute("title")),e.getAttribute("lang")&&(o.language=e.getAttribute("lang")),e.innerHTML&&(o.description=e.innerHTML);if((u=e.getAttribute("rev"))!==null&&u.substring(0,6)=="flattr"||(u=e.getAttribute("rel"))!==null&&u.substring(0,6)=="flattr"){u=u.substring(7).split(";");for(n=0;n<u.length;n++)r=u[n].split(":"),i=r.shift(),this.validParam(i,this.validButtonParams)&&(o[i]=r.join(":"))}else for(s in this.validButtonParams)this.validButtonParams.hasOwnProperty(s)&&(u=e.getAttribute(this.getParam("html5-key-prefix","data-flattr")+"-"+this.validButtonParams[s]))!==null&&(o[this.validButtonParams[s]]=u);this.replaceWith(e,this.createIframe(o))},render:function(e,t,n){var r,i={};for(r in this.options)this.options.hasOwnProperty(r)&&this.validParam(r,this.validButtonParams)&&(i[r]=this.options[r]);try{if(e)for(r in e)e.hasOwnProperty(r)&&this.validParam(r,this.validButtonParams)&&(i[r]=e[r]);else window.flattr_uid&&(i.uid=window.flattr_uid),window.flattr_url&&(i.url=window.flattr_url),window.flattr_btn&&(i.button=window.flattr_btn),window.flattr_hide&&(i.hidden=window.flattr_hide==1?1:0),window.flattr_cat&&(i.category=window.flattr_cat),window.flattr_tag&&(i.tags=window.flattr_tag),window.flattr_lng&&(i.language=window.flattr_lng),window.flattr_tle&&(i.title=window.flattr_tle),window.flattr_dsc&&(i.description=window.flattr_dsc);var s=this.createIframe(i);if(t){typeof t=="string"&&(t=document.getElementById(t));switch(n){case"before":t.parentNode.insertBefore(s,t);break;case"replace":this.replaceWith(t,s);break;case"append":default:t.appendChild(s)}}else this.getParam("mode","manual")=="direct"&&this.replaceWith(this.instance,this.createIframe(i))}catch(o){}},replaceWith:function(e,t){if(typeof t=="string")if(typeof document.documentElement.outerHTML!="undefined")e.outerHTML=t;else{var n=document.createRange();n.selectNode(e),t=n.createContextualFragment(t),e.parentNode.replaceChild(t,e)}var r=e.parentNode;r.replaceChild(t,e)},setup:function(){var e,t,n;if(document.querySelectorAll)try{n=document.querySelectorAll("a.FlattrButton")}catch(r){}if(n==undefined){n=[],e=document.getElementsByTagName("a");for(t=e.length-1;t>=0;t--)/FlattrButton/.test(e[t].className)&&(n[n.length]=e[t])}for(t=n.length-1;t>=0;t--)this.loadButton(n[t])},stripTags:function(e,t){var n="",r=!1,i=[],s=[],o="",u=0,a="",f="",l=function(e,t,n){return n.split(e).join(t)};t&&(s=t.match(/([a-zA-Z0-9]+)/gi)),e+="",i=e.match(/(<\/?[\S][^>]*>)/gi);for(n in i)if(i.hasOwnProperty(n)){if(isNaN(n))continue;f=i[n].toString(),r=!1;for(a in s)if(s.hasOwnProperty(a)){o=s[a],u=-1,u!=0&&(u=f.toLowerCase().indexOf("<"+o+">")),u!=0&&(u=f.toLowerCase().indexOf("<"+o+" ")),u!=0&&(u=f.toLowerCase().indexOf("</"+o));if(u==0){r=!0;break}}r||(e=l(f,"",e))}return e},validParam:function(e,t){var n;for(n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}};return e}();!function(e,t){function n(e){h=1;while(e=r.shift())e()}var r=[],i,s,o=!1,u=t.documentElement,a=u.doScroll,f="DOMContentLoaded",l="addEventListener",c="onreadystatechange",h=/^loade|c/.test(t.readyState);t[l]&&t[l](f,s=function(){t.removeEventListener(f,s,o),n()},o),a&&t.attachEvent(c,i=function(){/^c/.test(t.readyState)&&(t.detachEvent(c,i),n())}),e.domReady=a?function(t){self!=top?h?t():r.push(t):function(){try{u.doScroll("left")}catch(n){return setTimeout(function(){e.domReady(t)},50)}t()}()}:function(e){h?e():r.push(e)}}(FlattrLoader,document),FlattrLoader.init();